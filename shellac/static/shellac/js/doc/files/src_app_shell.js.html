<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/app/shell.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/shellac.html">shellac</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/app/shell.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/* global $, window, document, AudioContext, XMLHttpRequest, target_username, DEBUG */
&#x27;use strict&#x27;;


/**
 * @module shellac
 */
var shellac = (function () {

    //---------------- BEGIN MODULE DEPENDENCIES --------------
    var TAFFY   = require(&#x27;taffydb&#x27;).taffy,
        app_util = require(&#x27;./app_util.js&#x27;),
        util    = require(&#x27;../util.js&#x27;),
        sidebar = require(&#x27;./sidebar.js&#x27;),
        bar     = require(&#x27;../players/bar-ui.js&#x27;),
        async   = require(&#x27;async&#x27;);

    //---------------- END MODULE DEPENDENCIES --------------

    //---------------- BEGIN MODULE SCOPE VARIABLES --------------
    var

    utils = util.utils,
    PubSub = util.PubSub,

    initModule,
    initDom, initLatest, initPlaylist, initUIModules,
    registerPubSub,

    configMap = {
        main_html: String() +
            &#x27;&lt;div class=&quot;shellac-app-container&quot;&gt;&#x27; +
                &#x27;&lt;div class=&quot;shellac-app-player-container&quot;&gt;&lt;/div&gt;&#x27; +
                &#x27;&lt;div class=&quot;shellac-app-sidebar-container col-sm-3 col-md-2&quot;&gt;&lt;/div&gt;&#x27; +
                &#x27;&lt;div class=&quot;shellac-app-clip-container content&quot;&gt;&lt;/div&gt;&#x27; +
            &#x27;&lt;/div&gt;&#x27;,

        modal_html: String() +
            &#x27;&lt;div class=&quot;modal fade&quot; id=&quot;get_absolute_urlModal&quot; tabindex=&quot;-1&quot; role=&quot;dialog&quot; aria-labelledby=&quot;get_absolute_urlModal&quot; aria-hidden=&quot;true&quot;&gt;&#x27; +
                &#x27;&lt;div class=&quot;modal-dialog&quot;&gt;&#x27; +
                    &#x27;&lt;div class=&quot;modal-content&quot;&gt;&#x27; +
                        &#x27;&lt;div class=&quot;modal-header&quot;&gt;&#x27; +
                            &#x27;&lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot;&gt;&lt;span aria-hidden=&quot;true&quot;&gt;&amp;times;&lt;/span&gt;&lt;span class=&quot;sr-only&quot;&gt;Close&lt;/span&gt;&lt;/button&gt;&#x27; +
                        &#x27;&lt;/div&gt;&#x27; +
                        &#x27;&lt;div class=&quot;modal-body&quot;&gt;&lt;/div&gt;&#x27; +
                        &#x27;&lt;div class=&quot;modal-footer&quot;&gt;&#x27; +
                            &#x27;&lt;button type=&quot;button&quot; class=&quot;btn btn-default&quot; data-dismiss=&quot;modal&quot;&gt;Close&lt;/button&gt;&#x27; +
                        &#x27;&lt;/div&gt;&#x27; +
                    &#x27;&lt;/div&gt;&#x27; +
                &#x27;&lt;/div&gt;&#x27; +
            &#x27;&lt;/div&gt;&#x27;,

        truncatemax: 30,

        playlist_endpoint: String() + &#x27;/api/playlists/&#x27;,

        clip_endpoint: String() + &#x27;/api/clips/&#x27;,

        track_endpoint: String() + &#x27;/api/tracks/&#x27;
    },

    stateMap = {
        container           : undefined,
        user                : undefined,
        target_username     : undefined,
        status              : undefined,
        latest_clips_db     : TAFFY(),
        selected            : undefined,
        DEBUG               : undefined,
        csrftoken           : undefined,
        authtoken           : undefined
    },

    preferencesMap = {
        playlist_id         : undefined,
        playlist            : undefined,
        positionsMap        : {},
        clips               : undefined
    },

    playState = {
      STOPPED: 0,
      PLAYING: 1,
      BUFFERING: 1
    },

    css = {
        playing: &#x27;playing&#x27;,
        paused: &#x27;paused&#x27;,
        stopped: &#x27;stopped&#x27;
    },

    dom_selectors = {
        grid_element            : &#x27;.shellac-grid-element&#x27;,
        grid_element_panel      : &#x27;.shellac-grid-element-panel&#x27;,
        enqueue_icon            : &#x27;.enqueue-icon&#x27;,
        img_panel               : &#x27;.shellac-img-panel&#x27;,
        playstate               : &#x27;.shellac-playstate&#x27;,
        caption_panel           : &#x27;.shellac-caption-panel&#x27;,
        description_container   : &#x27;.shellac-description-container&#x27;,
        description_content     : &#x27;.shellac-description-content&#x27;
    },

    jqueryMap = {}, setJqueryMap,
    dom = {}, setDomMap,

    actions,
    render_clips, getClip,
    handleUrlFetch, handleClick,
    handlePlayerStateChange, handlePlaylistChange,
    handlePlayerSave;

    //---------------- END MODULE SCOPE VARIABLES --------------

    //--------------------- BEGIN MODULE SCOPE METHODS --------------------



    /**
     * @method setJqueryMap record the jQuery elements of the page
     * Required to support the bootstrap modal activities
     */
    setJqueryMap = function(){
        var $outerDiv = $(stateMap.container);
        jqueryMap = {
            $modal_container            : $outerDiv.find(&#x27;#get_absolute_urlModal&#x27;),
            $modal_header               : $outerDiv.find(&#x27;#get_absolute_urlModal .modal-dialog .modal-content .modal-header&#x27;),
            $modal_body                 : $outerDiv.find(&#x27;#get_absolute_urlModal .modal-dialog .modal-content .modal-body&#x27;),
            $modal_footer               : $outerDiv.find(&#x27;#get_absolute_urlModal .modal-dialog .modal-content .modal-footer&#x27;),
        };
    };

    /**
     * @method setDomMap record the DOM elements of the page
     */
    setDomMap = function(){
        var outerDiv = stateMap.container;
        dom = {
            outerDiv                : outerDiv,
            app_container           : utils.dom.get(outerDiv, &#x27;.shellac-app-container&#x27;),
            sidebar_container       : utils.dom.get(outerDiv, &#x27;.shellac-app-container .shellac-app-sidebar-container&#x27;),
            player_container        : utils.dom.get(outerDiv, &#x27;.shellac-app-container .shellac-app-player-container&#x27;),
            clip_content_container  : utils.dom.get(outerDiv, &#x27;.shellac-app-container .shellac-app-clip-container&#x27;),

            modal_container         : utils.dom.get(outerDiv, &#x27;#get_absolute_urlModal&#x27;),
            modal_header            : utils.dom.get(outerDiv, &#x27;#get_absolute_urlModal .modal-dialog .modal-content .modal-header&#x27;),
            modal_body              : utils.dom.get(outerDiv, &#x27;#get_absolute_urlModal .modal-dialog .modal-content .modal-body&#x27;),
            modal_footer            : utils.dom.get(outerDiv, &#x27;#get_absolute_urlModal .modal-dialog .modal-content .modal-footer&#x27;),
        };
    };

    /**
     * actions ui action-related event handlers
     */
    actions = {

        modal: function(target) {

            var url;

            //guard against IE9
            url = target.dataset.url || target.hasAttibute(&#x27;data-url&#x27;) ? target.getAttribute(&#x27;data-url&#x27;) : &#x27;&#x27;;

            if (url)
            {
                util.fetchUrl(url, function(results){
                    jqueryMap.$modal_body.html($(results).find(&#x27;.clip-detail-container&#x27;));
                    jqueryMap.$modal_container.modal(&#x27;show&#x27;);
                });
            }
        },

        /**
         * enqueue pass the corresponding to a clip to the player playlist
         * Action Add any clips database that are enqueued. These could be search results
         * that were not added to the database on init
         * @param target ElementNode for the clip to enqueue
         */
        enqueue : function(target) {

            var clip;

            if(!target.dataset.id)
            {
                return;
            }

            getClip(target.dataset.id, stateMap.latest_clips_db, function(clip){
                stateMap.selected = target;
                bar.playerEnqueue([clip], 0);
            });
        }
    };


    /**
     * @method initLatest fetches the latest clips which defaults to recent, following
     * @param done async callback
     */
    initLatest = function( status, username, done ){
        var clipsUrl = [&#x27;/api/clips&#x27;, status, username, &quot;&quot;].join(&#x27;/&#x27;);
        util.fetchUrl(clipsUrl, function( results ){
            var formatted = app_util.parseClipData( results );
            stateMap.latest_clips_db.insert( formatted );
            render_clips( stateMap.latest_clips_db().order(&quot;created_i desc&quot;).get() );
            done(null);
        });
    };


    /**
     * @method initPlaylist fetches the (default) playlist for this user and inflates
     * @param done async callback
     */
    initPlaylist = function( user, done ){

        var pMap, tracks;

        //Do 3 things.
        async.waterfall([
            function(callback){
                // 1. Fetch the default playlist
                util.fetchUrl(configMap.playlist_endpoint + preferencesMap.playlist_id + &#x27;/&#x27;, function( results ){
                    if(results.id.toString() === preferencesMap.playlist_id.toString())
                    {
                        preferencesMap.playlist = results;

                        if( results.hasOwnProperty(&#x27;tracks&#x27;) )
                        {
                            tracks = results.tracks;
                            callback(null, tracks);
                        }
                        else
                        {
                            callback(&quot;error initPlaylist: Failed to load Track list&quot;);
                        }
                    }
                    else
                    {
                        callback(&quot;error initPlaylist&quot;);
                    }
                });
            },
            function(tracks, callback)
            {
                var clipURLs = [];

                // 2. Now fetch the Tracks and populate the positionsMap with the
                // *** CLIP *** pk and NOT the Track pk
                // Precondition tracks are fetched
                async.each(tracks, function(track, finish) {
                    var track_pk;

                    track_pk = util.getURLpk( track );
                    if(!track_pk){ finish(&quot;error initPlaylist: Invalid Track pk&quot;); }

                    util.fetchUrl(configMap.track_endpoint + track_pk + &#x27;/&#x27;, function( results ){
                        var clip_pk;
                        if( results.hasOwnProperty(&#x27;id&#x27;) &amp;&amp;
                            results.hasOwnProperty(&#x27;position&#x27;) &amp;&amp;
                            results.hasOwnProperty(&#x27;clip&#x27;))
                        {
                            clip_pk = util.getURLpk( results.clip );
                            if(!clip_pk){ finish(&quot;error initPlaylist: Invalid Track.clip pk&quot;); }

                            preferencesMap.positionsMap[clip_pk] = results.position;
                            clipURLs.push( results.clip );
                            return finish(null);
                        }
                        finish(&quot;error initPlaylist: Track missing property&quot;);
                    });
                }, function(err) {
                    if(err)
                    {
                        callback(err);
                    }
                    else
                    {
                        callback(null, clipURLs);
                    }
                });
            },
            function(clipURLs, callback)
            {
                var clips = [];
                // 3. Now fetch the Clips and enqueue them with some position info
                async.each(clipURLs, function(clipURL, finish) {
                    var pk;

                    pk = util.getURLpk( clipURL );
                    if(!pk){ finish(&quot;error initPlaylist: Invalid Clip pk&quot;); }

                    util.fetchUrl(configMap.clip_endpoint + pk + &#x27;/&#x27;, function( results ){
                        clips.push(results);
                        finish(null);
                    });
                }, function(err) {
                    if(err)
                    {
                        callback(err);
                    }
                    else
                    {
                        //store out the clips for the UI init
                        preferencesMap.clips = clips;
                        callback(null);
                    }
                });
            }
        ],
        function(err){
            if(err) {
                done(err);
            }
            else
            {
                done(null);
            }
        });
    };

    /**
     * @method initUIModules installs other modules
     * @param done async callback
     */
    initUIModules = function( done ){
        var sidebar_toggle;

        //initialize the sidebar module
        sidebar.initModule( dom.sidebar_container, stateMap.latest_clips_db );
        sidebar_toggle = utils.dom.get(&#x27;.sidebar-toggle&#x27;);
        utils.events.add(sidebar_toggle, &#x27;click&#x27;, function(e){ utils.css.toggle(dom.sidebar_container, &#x27;nav-expanded&#x27;); });

        //initialize the bar-ui module
        bar.initModule( dom.player_container, preferencesMap.clips, preferencesMap.positionsMap, stateMap.DEBUG );

        done(null);
    };

    /**
     * @method initDom populates the shell UI with HTML
     */
    initDom = function( container ){
        utils.dom.append(container, configMap.main_html);
        utils.dom.append(container, configMap.modal_html);
        utils.dom.append(container, configMap.modal_button_html);
        setDomMap();
        setJqueryMap();
    };

    /**
     * @method retrieveClip use the primary key to retrieve the Clip object
     * Action fetch the clip from the latest clips db or makes an ajax request
     * for it otherwise. Add to the db in the latter case?
     * @param id a Number representing the Clip primary key
     * @param db the TAFFY db to look in or cache the result
     * @param callback the callback function upon request
     */
    getClip = function(id, db, callback){

        var clip,
            database = db || stateMap.latest_clips_db;

        //Try to retrieve the clip from the TAFFY database
        clip = database({id: parseInt(id)}).first();

        if(clip &amp;&amp; callback)
        {
            callback(clip);
        }
        else if(callback)
        {
            util.fetchUrl(configMap.clip_endpoint + id + &#x27;/&#x27;, function( results ){
                database.insert(results);
                callback(results);
            });
        }
        else
        {
            console.warn(&#x27;getClip error -- No callback&#x27;);
        }
    };

    //--------------------- END MODULE SCOPE METHODS --------------------


    //--------------------- BEGIN DOM METHODS --------------------
    /**
     * @method render_clips append the html for the clips to the main body of the page
     * Actions This should check for the presence of an &#x27;enqueue&#x27; class on each
     * &#x27;span.enqueue-icon&#x27; element every time clips are inserted
     * @param clipList the list of clip objects
     */

    //TOTDO shouldhav some way of knowing which clips are enqueued
    render_clips = function( clipList ){
      var container = dom.clip_content_container,
          clipString = String();

      //clear out any existing html nodes and listeners
      container.innerHTML = &quot;&quot;;
      utils.events.remove(container, &#x27;click&#x27;, handleClick);

      if(stateMap.latest_clips_db().count() === 0)
      {
          var message = String() +
              &#x27;&lt;div class=&quot;col-xs-12 shellac-grid-element no-content&quot;&gt;&#x27; +
                  &#x27;&lt;h3&gt;Nothing to hear here...&lt;/h3&gt;&#x27; +
              &#x27;&lt;/div&gt;&#x27;;
          container.innerHTML  = message;
          return;
      }

      clipList.forEach(function(object){

        var clip,
            created = object.created.startOf(&#x27;minute&#x27;).fromNow(true),
            categories = object.categories.length &gt; 0 ? object.categories.map(function(c){ return c.split(&#x27;/&#x27;)[5].toUpperCase(); })
                .slice(0,3)
                .join(&quot; | &quot;)
                .toString() : &quot;&amp;nbsp;&quot;,
            id = object.id.toString(),
            id_x = &quot;id_&quot; + id,
            enqueue = preferencesMap.positionsMap.hasOwnProperty(id) ? &#x27;enqueued&#x27; : &#x27;&#x27;,
            brand = object.brand_url === &#x27;&#x27; ? &#x27;/static/shellac/assets/avatar.jpeg&#x27; : object.brand_url,
            rating = &#x27;&lt;span class=&quot;glyphicon glyphicon-star-empty&quot;&gt;&lt;/span&gt;&lt;span class=&quot;glyphicon glyphicon-star-empty&quot;&gt;&lt;/span&gt;&#x27;;

        clipString +=
          &#x27;&lt;div class=&quot;col-xs-6 col-sm-4 shellac-grid-element&quot;&gt;&#x27; +
            &#x27;&lt;div class =&quot;shellac-grid-element-panel &#x27; + id_x + &#x27;&quot;&gt;&#x27; +

              &#x27;&lt;span class=&quot;glyphicon enqueue-icon glyphicon-ok-circle &#x27; + enqueue + &#x27;&quot;&gt;&lt;/span&gt;&#x27; +

              &#x27;&lt;div class=&quot;shellac-playstate&quot;&gt;&#x27; +
                &#x27;&lt;span class=&quot;icon-play icon play&quot;&gt;&lt;/span&gt;&#x27; +
                &#x27;&lt;span class=&quot;icon-pause icon pause&quot;&gt;&lt;/span&gt;&#x27; +
                &#x27;&lt;span class=&quot;icon-stop icon stop&quot;&gt;&lt;/span&gt;&#x27; +
              &#x27;&lt;/div&gt;&#x27; +

              &#x27;&lt;div class =&quot;shellac-img-panel&quot;&gt;&#x27; +
                &#x27;&lt;a href=&quot;#enqueue&quot; data-url=&quot;&#x27; + object.audio_file_url + &#x27;&quot; data-id=&quot;&#x27; + object.id + &#x27;&quot; data-title=&quot;&#x27; + object.title + &#x27;&quot; data-owner=&quot;&#x27; + object.owner + &#x27;&quot;&gt;&#x27; +
                  &#x27;&lt;img class=&quot;img-thumbnail shellac-grid-img &quot; src=&quot;&#x27; + brand + &#x27;&quot; alt=&quot;&#x27; + util.truncate(object.title, configMap.truncatemax) + &#x27;&quot; /&gt;&#x27; +
                &#x27;&lt;/a&gt;&#x27; +
              &#x27;&lt;/div&gt;&#x27; +

                &#x27;&lt;div class =&quot;shellac-caption-panel&quot;&gt;&#x27; +
                  &#x27;&lt;a href=&quot;#modal&quot; data-url=&quot;&#x27; + object.permalink + &#x27;&quot;&gt;&#x27; +
                    &#x27;&lt;div class =&quot;shellac-description-container&quot;&gt;&#x27; +
                      &#x27;&lt;div class=&quot;shellac-description-content title&quot;&gt;&#x27; + util.truncate(object.title, configMap.truncatemax) + &#x27;&lt;/div&gt;&#x27; +
                      &#x27;&lt;div class=&quot;shellac-description-content owner&quot;&gt;&#x27; + object.owner + &#x27;&lt;/div&gt;&#x27; +
                      &#x27;&lt;div class=&quot;shellac-description-content description-short&quot;&gt;&#x27; + util.truncate(object.description , configMap.truncatemax) + &#x27;&lt;/div&gt;&#x27; +
                      &#x27;&lt;div class=&quot;meta-data&quot;&gt;&#x27; +
                        &#x27;&lt;div class=&quot;shellac-description-content plays&quot;&gt;&#x27; + object.plays + &#x27; plays&lt;/div&gt;&#x27; +
                        &#x27;&lt;div class=&quot;shellac-description-content created&quot;&gt;&#x27; + created + &#x27;&lt;/div&gt;&#x27; +
                      &#x27;&lt;/div&gt;&#x27; +
                    &#x27;&lt;/div&gt;&#x27; +
                  &#x27;&lt;/a&gt;&#x27; +
                &#x27;&lt;/div&gt;&#x27; +

            &#x27;&lt;/div&gt;&#x27; +
          &#x27;&lt;/div&gt;&#x27;;
      });

      container.innerHTML = clipString;

      // (re-)register click events on &lt;a&gt; of the entire ui
      utils.events.add(container, &#x27;click&#x27;, handleClick);
    };
    //--------------------- END DOM METHODS ----------------------

    //------------------- BEGIN EVENT HANDLERS -------------------

    /**
     * @method handleClick Callback for a click event on the entire UI
     * Actions: processes the clicking an anchor element.
     * @param e event object
     */
    handleClick = function(e) {

        var evt,
            target,
            offset,
            targetNodeName,
            methodName,
            href,
            handled;

        evt = (e || window.event);

        target = evt.target || evt.srcElement;

        if (target &amp;&amp; target.nodeName) {

            targetNodeName = target.nodeName.toLowerCase();

            if (targetNodeName !== &#x27;a&#x27;) {

                // old IE (IE 8) might return nested elements inside the &lt;a&gt;, eg.,
                // &lt;b&gt; etc. Try to find the parent &lt;a&gt;.

                if (target.parentNode) {

                    do {
                        target = target.parentNode;
                        targetNodeName = target.nodeName.toLowerCase();
                    } while (targetNodeName !== &#x27;a&#x27; &amp;&amp; target.parentNode);

                    if (!target) {
                        // something went wrong. bail.
                        return false;
                    }

                }

            }

            if (targetNodeName === &#x27;a&#x27;) {

                // yep, it&#x27;s a link.
                href = target.href;

                //excluded
                if (utils.css.has(target, &#x27;shellac-exclude&#x27;)) {

                    //do nothing

                } else {

                    // is this one of permalink, toggleq, ...
                    offset = target.href.lastIndexOf(&#x27;#&#x27;);

                    if (offset !== -1) {
                        methodName = target.href.substr(offset + 1);
                        if (methodName &amp;&amp; actions[methodName]) {
                            handled = true;
                            actions[methodName](target);
                        }
                    }

                    // fall-through case
                    if (handled) {
                        // prevent browser fall-through
                        return utils.events.preventDefault(evt);
                    }

                }

            }// end if (targetNodeName === &#x27;a&#x27;)

        }//end if (target &amp;&amp; target.nodeName)
    };
    // --- END handleClick ---

    /**
     * @method handlePlaylistChange Handler for change in Player playlist
     * Toggles the display value of check mark
     * @param item HTMLElement added / removed from playlist
     * @param isAdded true if element was added
     * @param the updated map of clip id&#x27;s in the playlist
     */
    handlePlaylistChange = function( item, isAdded, pMap ){

        var anchor, pathname, parent, enqueue,
            selected_pathname,
            id_x, id, nodeList, i, j;

        //update the positionMap
        preferencesMap.positionsMap = JSON.parse(JSON.stringify(pMap));

        //update the particular Clip in the UI
        anchor = utils.dom.get(item, &#x27;a.sm2-track&#x27;);

        //ensure there is an anchor and the selected is defined
        // stateMap.selected is defined after a shell click event
        if(anchor) {
            pathname = util.urlParse(anchor.href).pathname;

            if (stateMap.selected) {
                //Case I: stateMap.selected is defined so it&#x27;s a shell change
                //Locate the &lt;span class=&quot;enqueue-icon&quot;&gt; from stateMap.selected

                selected_pathname = util.urlParse(stateMap.selected.dataset.url).pathname;

                //make sure the stateMap last clicked is this one
                if (selected_pathname === pathname) {
                    parent = stateMap.selected;

                    //should crawl up the dom to find this
                    do {
                        parent = parent.parentNode;
                        enqueue = utils.dom.get(parent, &#x27;.enqueue-icon&#x27;);
                    } while (enqueue.length === 0 &amp;&amp; parent.parentNode);

                }
                //clear out selected
                stateMap.selected = undefined;
            }
            else
            {
                //Case II: it&#x27;s a player ui change event or DB load
                // Find the right &lt;span.enqueue-icon&gt; for the anchor
                id_x = (anchor.dataset.id).split(&#x27;_&#x27;);
                if( id_x.length &lt; 2 || isNaN( parseInt(id_x[1])) ){ return; }

                id = [&#x27;.shellac-grid-element-panel&#x27;, anchor.dataset.id].join(&#x27;.&#x27;);
                nodeList = utils.dom.getAll(dom.clip_content_container, id);

                //get the last one
                if(!nodeList.length){ return; }
                enqueue = utils.dom.get(nodeList[nodeList.length - 1], &#x27;.enqueue-icon&#x27;);
            }

            if (isAdded) {
                utils.css.add(enqueue, &#x27;enqueued&#x27;);
            }
            else {
                utils.css.remove(enqueue, &#x27;enqueued&#x27;);
            }
        }
    };

    /**
     * @method handlePlayerStateChange Handler for change in player state
     * @param state string identifier indicating the type of state change
     * @param sm2Object the relevant soundManager sound object
     */

    ///this needs to update when sidebar emit signals
    handlePlayerStateChange = function(state, sm2Object){
//        console.log(&quot;handlePlayerStateChange&quot;);
//        console.log(state);

        var selector, nodeList, parent, panel,
            i, j;

        switch (state) {
            case &#x27;onplay&#x27;:

                var id_components, id,
                    clip, plays,
                    payload = {
                        plays: undefined
                    };


                //retrieve the id; bail if this doesn&#x27;t exist
                id_components = sm2Object.id.split(&quot;_&quot;);
                if (id_components.length !== 2) {
                    console.warn(&#x27;onplay error: No Clip id attribute&#x27;);
                    return;
                }

                id = parseInt(id_components[1]);
                getClip(id, stateMap.latest_clips_db, function(clip){
                    var plays;

                    plays = clip.plays;
                    payload.plays = plays + 1;

                    util.updateUrl(configMap.clip_endpoint + id + &#x27;/&#x27;, utils.noop,
                        &#x27;PATCH&#x27;, JSON.stringify(payload), stateMap.csrftoken);
                });

                break;
            default:
        }

        //update the ui
        selector = [&#x27;.shellac-grid-element-panel&#x27;, sm2Object.id].join(&#x27;.&#x27;);
        nodeList = utils.dom.getAll(dom.clip_content_container, selector);

        //check if there is a nodeList retrieved
        //if so, clear out the clip states and highlight clip
        if( nodeList === undefined || !nodeList.length ){ return; }

        parent = nodeList[nodeList.length - 1];
        panel = utils.dom.getAll(parent, dom_selectors.playstate);

        if( !panel.length ){ return; }

        //Query actions: pause(), resume(), togglePause()
//        console.log(&quot;sm2Object.paused: %s&quot;, sm2Object.paused);
//        console.log(&quot;sm2Object.playState : %s&quot;, sm2Object.playState );

        if(sm2Object.paused)
        {
            utils.css.remove(panel[panel.length - 1], css.playing);
            utils.css.add(panel[panel.length - 1], css.paused);
        }
        else if( sm2Object.playState === playState.PLAYING )
        {
            utils.css.remove(panel[panel.length - 1], css.paused);
            utils.css.remove(panel[panel.length - 1], css.stopped);
            utils.css.add(panel[panel.length - 1], css.playing);
        }
        else if( sm2Object.playState === playState.STOPPED)
        {
            utils.css.remove(panel[panel.length - 1], css.playing);
            utils.css.remove(panel[panel.length - 1], css.paused);
            utils.css.add(panel[panel.length - 1], css.stopped);
        }

    };


    /**
     * @method handlePlayerSave Handler for the sm2 player &#x27;save&#x27; action
     * Action Clears out Track objects from the default playlist; Post
     * Track objects to default playlist that exist in pMap
     * @param pMap the positions map PlaylistController (exportPositionsMap())
     * consisting of pattern {Clip_pk: position_pk, ..., clip_pk: position_pk} for
     * each Clip in playlist
     */
    handlePlayerSave = function( pMap ){

        var playlistPersonURL = preferencesMap.playlist.person;

        //update the positionMap
        preferencesMap.positionsMap = JSON.parse(JSON.stringify(pMap));

        async.waterfall([
            function(callback){
                // 1. Haaack - clear out the playlist
                util.alert(dom.app_container, &quot;warning&quot;, &quot;Saving playlist...&quot;, 60 * 1000);

                async.series([
                    function(done)
                    {
                        var playlistURL = configMap.playlist_endpoint + preferencesMap.playlist_id + &#x27;/&#x27;;

                        //Delete default playlist for existing preferencesMap.playlist_id
                        util.updateUrl(playlistURL, function( results ){
                            done(null);
                        }, &#x27;DELETE&#x27;, JSON.stringify(&#x27;{}&#x27;), stateMap.csrftoken);
                    },

                    function(done)
                    {
                        //Create a new playlist
                        var payload =
                        {
                            &quot;title&quot;: &quot;default&quot;,
                            &quot;description&quot;: &quot;default&quot;,
                            &quot;person&quot;: playlistPersonURL
                        };

                        util.updateUrl(configMap.playlist_endpoint, function( results ){

                            //reinstall the new playlist
                            preferencesMap.playlist = results;
                            preferencesMap.playlist_id = results.id;
                            done(null);
                        }, &#x27;POST&#x27;, JSON.stringify( payload ), stateMap.csrftoken);
                    }
                ],
                // optional callback
                function(err)
                {
                    if(err)
                    {
                        callback(err);
                    }
                    else
                    {
                        callback(null);
                    }
                });

            },
            function(callback){
                // 2. Create the Track map
                // Verify that each item is a valid clip:
                // for each key fetch /api/clips/&lt;key&gt;/ and
                // store a map of clip urls and positions in trackMap

                var keys,
                    trackMap = {};

                keys = Object.keys(preferencesMap.positionsMap);
                async.each(keys, function(key, done) {
                    util.fetchUrl(configMap.clip_endpoint + key + &#x27;/&#x27;, function( results ){
                        //store {Clip_id_1: position_1, ..., Clip_id_n: position_n}
                        trackMap[results.id] = preferencesMap.positionsMap[key];
                        done(null);
                    });
                }, function(err) {
                    callback(null, trackMap);
                });
            },
            function(trackMap, callback){
                //3. Post a new Track for each clip in the positions map (pMap)
                var clipIDs = Object.keys(trackMap);

                async.each(clipIDs, function(clipID, done) {

                    var payload = {
                        &quot;clip&quot;: configMap.clip_endpoint + clipID + &#x27;/&#x27;,
                        &quot;position&quot;: trackMap[clipID],
                        &quot;playlist&quot;: configMap.playlist_endpoint + preferencesMap.playlist_id + &#x27;/&#x27;
                    };
                    util.updateUrl(configMap.track_endpoint, function( results ){
                        done(null);
                    }, &#x27;POST&#x27;, JSON.stringify(payload), stateMap.csrftoken);

                }, function(err) {
                    callback(null);
                });
            }
        ],
        // optional callback
        function(err){
            if(err)
            {
                console.warn(err);
                util.alert(dom.app_container, &quot;success&quot;, &quot;Error: Not saved&quot;);
            }
            else
            {
                util.alert(dom.app_container, &quot;success&quot;, &quot;Playlist saved&quot;);
            }

        });
    };


    /**
     * @method registerPubSub Registration function for the various PubSub events
     * @param container the DOM HTMLElement app container
     */
    registerPubSub = function() {
        //register events
        util.PubSub.on(&#x27;playlist-change&#x27;, handlePlaylistChange);
        util.PubSub.on(&#x27;player-change&#x27;, handlePlayerStateChange);
        util.PubSub.on(&#x27;shellac-app-clip-change&#x27;, render_clips);
        util.PubSub.on(&#x27;player-save&#x27;, handlePlayerSave);
    };
    //-------------------- END EVENT HANDLERS --------------------

    //------------------- BEGIN PUBLIC METHODS -------------------
    /**
     * @method initModule Populates container with the shell of the UI
     * and then configures and initializes feature modules.
     * The Shell is also responsible for browser-wide issues
     * Directs this app to offer its capability to the user
     * @param container A DOM HTMLElement that should represent a single DOM container
     * @param target_username account holder username for retrieving clips
     * @param DEBUG for debug purposes (root url)
     */
    initModule = function( container, user, target_username, status, playlist_id, DEBUG)
    {

        // load HTML and map jQuery collections
        stateMap.csrftoken = util.getCookie(&#x27;csrftoken&#x27;);
        stateMap.container = container;
        stateMap.target_username = target_username;
        stateMap.user = user;
        stateMap.status = status;
        stateMap.DEBUG = DEBUG;

        preferencesMap.playlist_id = playlist_id;

        if(stateMap.csrftoken)
        {
            initDom( container );
            registerPubSub();
            async.series([
                function(done)
                {
                    //Initialize default playlist
                    initPlaylist(user, done);
                },

                function(done)
                {
                    //Initialize latest clips (status)
                    initLatest( status, target_username, done);
                },

                function(done)
                {
                    //Initialize other UI modules
                    initUIModules(done);
                }
            ],
            // optional callback
            function(err)
            {
                if(err)
                { console.warn(err); }

                if(DEBUG)
                {
                  console.log(utils.dom.get(container, &#x27;.sm2-playlist-wrapper .sm2-playlist-bd&#x27;));
                }
            });
        }
        else
        { console.warn(&#x27;initModule failed - credentials missing&#x27;); }
    };

    return { initModule: initModule };
}());

module.exports = shellac;


    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
